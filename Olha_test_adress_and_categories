import pytest
import requests
import dicttoxml
import xmltodict

addresses_url = 'http://164.92.218.36:8080/api/addresses'
auth = ('1VQDHXQ8EF73QTHESPT7UHU9AJQPLXXL', '')

address = {
    "address": {
        "id_customer": "",
        "id_manufacturer": "",
        "id_supplier": "",
        "id_warehouse": "",
        "id_country": 1,
        "id_state": "",
        "alias": "artem",
        "company": "",
        "lastname": "Vorobiova",
        "firstname": "Olha",
        "vat_number": "",
        "address1": "Illinska street 184",
        "address2": "",
        "postcode": "",
        "city": "Charkiv",
        "other": "",
        "phone": "",
        "phone_mobile": "",
        "dni": ""
    }
}


def test_create_and_delete_address():
    #given
    xml = dicttoxml.dicttoxml(
        address, custom_root='prestashop', attr_type=False)
    
    #when create

    response = requests.post(addresses_url, data=xml, auth=auth)

    #then

    assert response.status_code == 201
    resultAddress = xmltodict.parse(response.content)['prestashop']['address']

    assert resultAddress['lastname'] == address['address']['lastname']
    id = resultAddress['id']

    response = requests.get(addresses_url + '/' + id, auth=auth)

    assert response.status_code == 200
    resultAddress = xmltodict.parse(response.content)['prestashop']['address']

    assert resultAddress['lastname'] == address['address']['lastname']
    assert resultAddress['id'] == id

    #when delete

    response = requests.delete(addresses_url + '/' + id, auth=auth)

    #then

    assert response.status_code == 200

    response = requests.get(addresses_url + '/' + id, auth=auth)

    assert response.status_code == 404

address_for_update = {
    "address": {
        "id":"",
        "id_customer": "",
        "id_manufacturer": "",
        "id_supplier": "",
        "id_warehouse": "",
        "id_country": 1,
        "id_state": "",
        "alias": "artem",
        "company": "",
        "lastname": "Vorobiova",
        "firstname": "Olha",
        "vat_number": "",
        "address1": "Illinska street 184",
        "address2": "",
        "postcode": "",
        "city": "Charkiv",
        "other": "",
        "phone": "",
        "phone_mobile": "",
        "dni": ""
    }
}

def test_update_address():
    #given address exists
    xml = dicttoxml.dicttoxml(
        address, custom_root='prestashop', attr_type=False)

    response = requests.post(addresses_url, data=xml, auth=auth) 
    resultAddress = xmltodict.parse(response.content)['prestashop']
    assert resultAddress['address']['firstname'] == "Olha"
    id = resultAddress['address']['id']
    address_for_update['address']['id'] = id
    address_for_update['address']['firstname'] = 'new name'

    #when address updated

    xml = dicttoxml.dicttoxml(
    address_for_update, custom_root='prestashop', attr_type=False)
    response = requests.put(addresses_url, auth=auth, data=xml)

    assert response.status_code == 200

    resultAddress = xmltodict.parse(response.content)['prestashop']['address']

    assert resultAddress['firstname'] == 'new name'
    assert resultAddress['id'] == id

    #clear data after test

    response = requests.delete(addresses_url + '/' + id, auth=auth)

def test_get_addresses_response_contains_created_adress():
    #given

    xml = dicttoxml.dicttoxml(
        address, custom_root='prestashop', attr_type=False)

    response = requests.post(addresses_url, data=xml, auth=auth) 
    resultAddress = xmltodict.parse(response.content)['prestashop']
    id = resultAddress['address']['id']

    #when

    response = requests.get(addresses_url, auth=auth)

    #then

    assert response.status_code == 200

    address_found = False
    for add in xmltodict.parse(response.content)['prestashop']['addresses']['address']:
        if add['@id'] == id:
            address_found = True
            break
    
    assert address_found 

    #clean

    response = requests.delete(addresses_url + '/' + id, auth=auth)





    

import pytest
import requests
import dicttoxml
import xmltodict

categories_url = 'http://164.92.218.36:8080/api/categories'
auth = ('1VQDHXQ8EF73QTHESPT7UHU9AJQPLXXL', '')

def test_get_categories():
    response = requests.get(categories_url, auth=auth)

    assert response.status_code == 200

    print(response)

payload = '''<?xml version="1.0" encoding="UTF-8"?>
    <prestashop xmlns:xlink="http://www.w3.org/1999/xlink">
        <category>
            <id_parent></id_parent>
            <active>0</active>
            <id_shop_default></id_shop_default>
            <is_root_category>0</is_root_category>
            <position></position>
            <date_add></date_add>
            <date_upd></date_upd>
            <name><language id="1" xlink:href="http://164.92.218.36:8080/api/languages/1">new name</language></name>
            <link_rewrite>
                <language id="1" xlink:href="http://164.92.218.36:8080/api/languages/1"></language>
            </link_rewrite>
            <description>
                <language id="1" xlink:href="http://164.92.218.36:8080/api/languages/1"></language>
            </description>
            <meta_title>
                <language id="1" xlink:href="http://164.92.218.36:8080/api/languages/1"></language>
            </meta_title>
            <meta_description>
                <language id="1" xlink:href="http://164.92.218.36:8080/api/languages/1"></language>
            </meta_description>
            <meta_keywords>
                <language id="1" xlink:href="http://164.92.218.36:8080/api/languages/1"></language>
            </meta_keywords>
            <associations>
                <categories nodeType="category" api="categories"/>
                <products nodeType="product" api="products"/>
            </associations>
        </category>
    </prestashop>'''

def test_create_category():
    
    headers = {"Content-Type": "application/xml"}
    response = requests.post(categories_url, headers=headers, auth=auth, data=payload)

    assert response.status_code == 201
    resultCategories = xmltodict.parse(response.content)['prestashop']['category']
    

    assert resultCategories ['name']['language']['#text'] == 'new name'
    id = resultCategories ['id']

    response = requests.get(categories_url + '/' + id, auth=auth)

    assert response.status_code == 200
    resultCategories  = xmltodict.parse(response.content)['prestashop']['category']

    assert resultCategories['name']['language']['#text'] == 'new name'
    assert resultCategories ['id'] == id

   
    
def test_put_category_405_not_enough_permissions():
    headers = {"Content-Type": "application/xml","Accept": "application/xml"}
    response = requests.put(categories_url, headers=headers, auth=auth, data=payload)

    assert response.status_code == 405
    


    
def test_delete_category_405_not_enough_permissions():
    headers = {"Content-Type": "application/xml","Accept": "application/xml"}
    response = requests.put(categories_url, headers=headers, auth=auth, data=payload)

    assert response.status_code == 405
    




    
